/*~~~>
    Thank you Phunks, your inspiration and phriendship meant the world to me and helped me through hard times.
      Never stop phighting, never surrender, always stand up for what is right and make the best of all situations towards all people.
      Phunks are phreedom phighters!
        "When the power of love overcomes the love of power the world will know peace." - Jimi Hendrix <3

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(((((((((((((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(((((((((((((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((((((((((((((((((((((@@@@@##############################%%%%%@@@@@((((((((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((((((((((((((((((((((@@@@@##############################%%%%%@@@@@((((((((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((@@@@@########################################%%%%%@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((@@@@@########################################%%%%%@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@###############@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@###############@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@##########@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@##########@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@/////////////////////////////////////////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@/////////////////////////////////////////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@#PHUNKYJON///////////////#PHUNKYJON//////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@#PHUNKYJON///////////////#PHUNKYJON//////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@/////@EYES////////////////////@EYES///////////////@@@@@((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@/////@EYES////////////////////@EYES///////////////EAR@@((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@//////////////////////////////////////////////////EAR@@((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@//////////////////////////////////////////////////EAR@@((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@/////////////////////////////////////////////@@@@@@@@@@((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@/////////////////////////////////////////////@@@@@@@@@@((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@//////////NOSE@NOSE@////////////////////#####@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@//////////NOSE@NOSE@////////////////////#####@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((@@@@@#####//////////////////////////////##########@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((@@@@@#####//////////////////////////////##########@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((@SPLIFF@SPLIFF@SPLIFF@SPLIFF@@###################################@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((@SPLIFF@SPLIFF@SPLIFF@SPLIFF@@###################################@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((EMBER(((((,,,,,,,,,,,,,,,,,,,,,,,,,@@@@@MOUTH&&&&&####################@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((EMBER(((((,,,,,,,,,,,,,,,,,,,,,,,,,@@@@@MOUTH&&&&&####################@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((@SPLIFF@SPLIFF@SPLIFF@SPLIFF@@##############################/////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((@SPLIFF@SPLIFF@SPLIFF@SPLIFF@@##############################/////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((((((((((((((((((((((@@@@@##############################//////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((((((((((((((((((((((@@@@@##############################//////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@///////////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@///////////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((@@@@@///////////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((@@@@@///////////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@///////////////@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@///////////////@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

 <~~~*/
pragma solidity >=0.8.0 <0.9.0;

import "@openzeppelin/contracts/utils/Counters.sol";
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
import "@openzeppelin/contracts/utils/math/SafeMath.sol";
import "@openzeppelin/contracts/security/Pausable.sol";

/*~~~>
Interface declarations for upgradable contracts
<~~~*/
interface MarketNFT {
  function safeMint(address to) external;
}
interface PhamNFT {
  function balanceOf(address owner) external returns(uint);
}
interface IERC20 {
  function balanceOf(address account) external view returns (uint256);
  function allowance(address owner, address spender) external view returns (uint256);
  function transfer(address recipient, uint256 amount) external returns (bool);
  function approve(address spender, uint256 amount) external returns (bool);
  function transferFrom(address sender, address recipient, uint256 amount) external returns (bool);
  event Transfer(address indexed from, address indexed to, uint256 value);
  event Approval(address indexed owner, address indexed spender, uint256 value);
}
interface RoleProvider {
  function hasTheRole(bytes32 role, address _address) external returns(bool);
  function fetchAddress(bytes32 _var) external returns(address);
}
interface RewardsController {
  function createNftHodler(uint tokenId) external;
  function depositEthToDAO() payable external;
  function depositERC20Rewards(uint amount, address tokenAddress) external;
}
contract Mint is ReentrancyGuard, Pausable {
  using SafeMath for uint;
  using Counters for Counters.Counter;
  /*~~~>
    State variables
  <~~~*/
  Counters.Counter private _nftsCreated;
  Counters.Counter private _redemptionERC20;

  uint public deployAmount;
  address public roleAdd;

  bytes32 public constant NFTADD = keccak256("NFT");

  bytes32 public constant REWARDS = keccak256("REWARDS");

  //*~~~> Marketplace NFT that can be used to claim rewards and act as a DAO
  struct NFT {
    uint itemId;
    address creator;
  }
  //*~~~> Tokens redeemed to create Marketplace NFTs
  struct RedemptionToken {
    uint redeemAmount;
    address contractAddress;
  }

  //*~~~> Roles for designated accessibility
  bytes32 public constant PROXY_ROLE = keccak256("PROXY_ROLE"); 
  bytes32 public constant DEV_ROLE = keccak256("DEV_ROLE");
  modifier hasAdmin(){
    require(RoleProvider(roleAdd).hasTheRole(PROXY_ROLE, msg.sender), "DOES NOT HAVE ADMIN ROLE");
    _;
  }
  modifier hasDevAdmin(){
    require(RoleProvider(roleAdd).hasTheRole(DEV_ROLE, msg.sender), "DOES NOT HAVE DEV ROLE");
    _;
  }

  constructor(address _role) {
    roleAdd =_role;
  }

  //*~~~> Memory mappings
  mapping (uint256 => NFT) private _idToNft;
  mapping (uint256 => RedemptionToken) private _idToRedemption;
  mapping (address => uint) private _indexToRedemptionToken;

  // Event declaration
  event nftCreated(uint nftId, address creator);
  event Received(address, uint);

  /*~~~>
    Restricted access functions for mutable state variables  
  <~~~*/
  function setRoleAdd(address _role) public hasAdmin returns(bool){
    roleAdd = _role;
    return true;
  }

  /// @notice
  /*~~~>
    Function for re - setting the redemption token details
  <~~~*/
  /// @dev
  /*~~~>
    uint _redeemAmount: Amount needed to redeem a NFT; 
    address _contract: address of the redemption token;
  <~~~*/
  function resetRedemptionToken(uint _redeemAmount, address _contract) public hasAdmin returns(bool){
    uint index = _indexToRedemptionToken[_contract];
    _idToRedemption[index] = RedemptionToken(_redeemAmount, _contract);
    return true;
  }
  
  /// @notice
  /*~~~> Function for setting new redemption tokens <~~~*/
  /// @dev
  /*~~~> 
    uint amount: amount needed to redeem for creating new NFTs;
    address _toke: address for the token;
  <~~~*/
  /// @return Bool
  function setNewRedemption(uint amount, address _toke) public hasAdmin returns(bool){
    _redemptionERC20.increment();
    uint id = _redemptionERC20.current();
    _idToRedemption[id] = RedemptionToken(amount, _toke);
    return true;
  }

  /// @notice
  /*~~~>
  Public interaction function for creating new NFTs by exchanging Tokens
  <~~~*/
  /// @dev
  /*~~~>
    uint id: index to the redemption token struct;
    uint amount: amount needed to redeem;
    uint count: amount of NFTs to redeem;
    address to: address to mint the NFT to;
  <~~~*/
  /// @return Bool
  function redeemForNft(uint id, uint amount, address to) public whenNotPaused returns(bool){

    address rewardsAddress =  RoleProvider(roleAdd).fetchAddress(REWARDS);
    address nftAddress = RoleProvider(roleAdd).fetchAddress(NFTADD);

    RedemptionToken memory token = _idToRedemption[id];
    require(amount >= token.redeemAmount);

    IERC20 tokenContract = IERC20(token.contractAddress);
    uint256 allowance = tokenContract.allowance(msg.sender, address(this));
    require(allowance >= amount, "Check the token allowance");
    tokenContract.transferFrom(msg.sender, (address(this)), amount);
    
    MarketNFT(nftAddress).safeMint(to);
    _nftsCreated.increment();
    uint256 nftId = _nftsCreated.current();
    _idToNft[nftId] = NFT(nftId, msg.sender);
    (tokenContract).transfer(rewardsAddress, amount);
    RewardsController(rewardsAddress).depositERC20Rewards(amount, token.contractAddress);
    RewardsController(rewardsAddress).createNftHodler(nftId);

    emit nftCreated(nftId, msg.sender);
    return true;
  }


  /// @notice
  /*~~~>
  Functions for retrieving memory items
  <~~~*/

  function fetchRedemptionTokens() public view returns (RedemptionToken[] memory) {
    uint itemCount = _redemptionERC20.current();
    RedemptionToken[] memory tokens = new RedemptionToken[](itemCount);
    uint currentIndex;
    for (uint i; i < itemCount; i++) {
      RedemptionToken storage currentItem = _idToRedemption[i + 1];
      tokens[currentIndex] = currentItem;
      currentIndex++;
    }
    return tokens;
  }

  function fetchNFTsCreated() public view returns (NFT[] memory) {
    uint itemCount = _nftsCreated.current();
    NFT[] memory nfts = new NFT[](itemCount);
    uint currentIndex;
    for (uint i; i < itemCount; i++) {
      NFT storage currentItem = _idToNft[i + 1];
      nfts[currentIndex] = currentItem;
      currentIndex++;
    }
    return nfts;
  }

  function fetchNFTsCreatedCount() public view returns (uint) {
    uint itemCount = _nftsCreated.current();
    return itemCount;
  }

  function fetchNFTsCreatedByAddress(address creator) public view returns (NFT[] memory) {
    uint itemCount = _nftsCreated.current();
    NFT[] memory nfts = new NFT[](itemCount);
    uint currentIndex;
    for (uint i; i < itemCount; i++) {
      if (_idToNft[i + 1].creator == creator) {
        NFT storage currentItem = _idToNft[i + 1];
         nfts[currentIndex] = currentItem;
         currentIndex++;
      }
    }
    return nfts;
  }

  ///@notice DEV operations for emergency functions
  function pause() public hasDevAdmin {
      _pause();
  }
  function unpause() public hasDevAdmin {
      _unpause();
  }

  ///@notice
  /*~~~> External ETH transfer forwarded to role provider contract <~~~*/
  event FundsForwarded(uint value, address _from, address _to);
  receive() external payable {
    payable(roleAdd).transfer(msg.value);
      emit FundsForwarded(msg.value, msg.sender, roleAdd);
  }
}
